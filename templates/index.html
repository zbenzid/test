<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Planning App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .high-priority { background-color: #ffcccc; }
        .medium-priority { background-color: #ffffcc; }
        .low-priority { background-color: #ccffcc; }
        .near-due-date { font-weight: bold; color: #ff0000; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">üìã Team Planning App</h1>
        <div id="dashboard" class="mb-4"></div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h2>‚ûï Add New Task</h2>
                <form id="add-task-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="text" class="form-control" name="title" placeholder="Task Title üìù" required>
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control" name="description" placeholder="Task Description üìÑ" required></textarea>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="assigned_to" placeholder="Assigned To üë§" required>
                    </div>
                    <div class="mb-3">
                        <label for="due_date">Due Date üìÖ</label>
                        <input type="date" class="form-control" name="due_date" id="due_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="priority">Priority ‚ö†Ô∏è</label>
                        <select class="form-control" name="priority" id="priority" required>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="categories" placeholder="Categories (comma-separated) üè∑Ô∏è">
                    </div>
                    <div class="mb-3">
                        <label for="file">Attachment üìé</label>
                        <input type="file" class="form-control" name="file" id="file">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="recurring" id="recurring">
                            <label class="form-check-label" for="recurring">Recurring Task üîÅ</label>
                        </div>
                    </div>
                    <div id="recurring-options" style="display: none;">
                        <div class="mb-3">
                            <label for="recurring_interval">Repeat every:</label>
                            <input type="number" class="form-control" name="recurring_interval" id="recurring_interval" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="recurring_unit">Unit:</label>
                            <select class="form-control" name="recurring_unit" id="recurring_unit">
                                <option value="day">Day(s)</option>
                                <option value="week">Week(s)</option>
                                <option value="month">Month(s)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Task ‚ûï</button>
                </form>
            </div>
            <div class="col-md-6">
                <h2>üîç Filter Tasks</h2>
                <form id="filter-form">
                    <div class="mb-3">
                        <label for="sort_by">Sort By üî¢</label>
                        <select class="form-control" name="sort_by" id="sort_by">
                            <option value="due_date">Sort by Due Date</option>
                            <option value="priority">Sort by Priority</option>
                            <option value="status">Sort by Status</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filter_status">Filter by Status üö¶</label>
                        <select class="form-control" name="filter_status" id="filter_status">
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filter_priority">Filter by Priority ‚ö†Ô∏è</label>
                        <select class="form-control" name="filter_priority" id="filter_priority">
                            <option value="">All Priorities</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="filter_category" placeholder="Filter by Category üè∑Ô∏è">
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="search" placeholder="Search tasks üîé">
                    </div>
                    <button type="submit" class="btn btn-secondary">Apply Filters üîç</button>
                </form>
            </div>
        </div>

        <h2>üìã Task List</h2>
        <div id="task-list"></div>
    </div>

    <div class="container mt-3">
        <h3>üìå Instructions</h3>
        <ul>
            <li>Add a new task using the form on the left.</li>
            <li>Use the filter options on the right to sort and filter tasks.</li>
            <li>Click the "Update" button to change a task's status, priority, or due date.</li>
            <li>Tasks with due dates within 3 days will be highlighted in red.</li>
            <li>You can add comments to tasks and create subtasks.</li>
            <li>Track time spent on tasks using the time tracking feature.</li>
            <li>Attach files to tasks for better organization.</li>
            <li>Create recurring tasks for repetitive work.</li>
        </ul>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function loadDashboard() {
            $.get('/dashboard', function(data) {
                let dashboardHtml = `
                    <h2>Dashboard üìä</h2>
                    <p>Total Tasks: ${data.total_tasks}</p>
                    <p>Completed Tasks: ${data.completed_tasks}</p>
                    <p>Completion Rate: ${data.completion_rate.toFixed(2)}%</p>
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="priorityChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                `;
                $('#dashboard').html(dashboardHtml);

                new Chart(document.getElementById('priorityChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data.tasks_by_priority),
                        datasets: [{
                            data: Object.values(data.tasks_by_priority),
                            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56']
                        }]
                    },
                    options: {
                        title: {
                            display: true,
                            text: 'Tasks by Priority'
                        }
                    }
                });

                new Chart(document.getElementById('statusChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data.tasks_by_status),
                        datasets: [{
                            data: Object.values(data.tasks_by_status),
                            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56']
                        }]
                    },
                    options: {
                        title: {
                            display: true,
                            text: 'Tasks by Status'
                        }
                    }
                });
            });
        }

        function loadTasks(filters = {}) {
            $.get('/tasks', filters, function(tasks) {
                let taskHtml = '<table class="table table-striped"><thead><tr><th>Title</th><th>Description</th><th>Assigned To</th><th>Due Date</th><th>Status</th><th>Priority</th><th>Categories</th><th>Action</th></tr></thead><tbody>';
                tasks.forEach(function(task) {
                    const dueDate = new Date(task.due_date);
                    const today = new Date();
                    const diffTime = dueDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const nearDueDate = diffDays <= 3 ? 'near-due-date' : '';
                    const statusEmoji = task.status === 'Pending' ? '‚è≥' : (task.status === 'In Progress' ? 'üèóÔ∏è' : '‚úÖ');
                    const priorityEmoji = task.priority === 'High' ? 'üî¥' : (task.priority === 'Medium' ? 'üü°' : 'üü¢');
                    taskHtml += `
                        <tr class="${task.priority.toLowerCase()}-priority">
                            <td>üìù ${task.title}</td>
                            <td>üìÑ ${task.description}</td>
                            <td>üë§ ${task.assigned_to}</td>
                            <td class="${nearDueDate}">üìÖ ${task.due_date}</td>
                            <td>${statusEmoji} ${task.status}</td>
                            <td>${priorityEmoji} ${task.priority}</td>
                            <td>üè∑Ô∏è ${task.categories}</td>
                            <td>
                                <form class="update-task-form" data-task-id="${task.id}">
                                    <select name="status" class="form-control mb-2">
                                        <option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>‚è≥ Pending</option>
                                        <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>üèóÔ∏è In Progress</option>
                                        <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>‚úÖ Completed</option>
                                    </select>
                                    <select name="priority" class="form-control mb-2">
                                        <option value="High" ${task.priority === 'High' ? 'selected' : ''}>üî¥ High</option>
                                        <option value="Medium" ${task.priority === 'Medium' ? 'selected' : ''}>üü° Medium</option>
                                        <option value="Low" ${task.priority === 'Low' ? 'selected' : ''}>üü¢ Low</option>
                                    </select>
                                    <input type="date" name="due_date" value="${task.due_date}" class="form-control mb-2">
                                    <button type="submit" class="btn btn-sm btn-primary">Update üîÑ</button>
                                </form>
                                <button class="btn btn-sm btn-info show-comments" data-task-id="${task.id}">Show Comments üí¨</button>
                                <button class="btn btn-sm btn-warning add-subtask" data-task-id="${task.id}">Add Subtask üîΩ</button>
                                <form class="time-tracking-form" data-task-id="${task.id}">
                                    <input type="number" name="time_spent" placeholder="Time spent (minutes)" class="form-control mb-2">
                                    <button type="submit" class="btn btn-sm btn-secondary">Log Time ‚è±Ô∏è</button>
                                </form>
                            </td>
                        </tr>
                        <tr id="comments-${task.id}" style="display: none;">
                            <td colspan="8">
                                <div class="comments-container"></div>
                                <form class="add-comment-form" data-task-id="${task.id}">
                                    <input type="text" name="content" placeholder="Add a comment" class="form-control mb-2">
                                    <button type="submit" class="btn btn-sm btn-primary">Add Comment üí¨</button>
                                </form>
                            </td>
                        </tr>
                    `;
                });
                taskHtml += '</tbody></table>';
                $('#task-list').html(taskHtml);
            });
        }

        $(document).ready(function() {
            loadDashboard();
            loadTasks();

            $('#add-task-form').submit(function(e) {
                e.preventDefault();
                let formData = new FormData(this);
                $.ajax({
                    url: '/add_task',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            loadTasks();
                            loadDashboard();
                            $('#add-task-form')[0].reset();
                            alert('Task added successfully!');
                        } else {
                            alert('Error adding task. Please try again.');
                        }
                    },
                    error: function() {
                        alert('Error adding task. Please try again.');
                    }
                });
            });

            $('#filter-form').submit(function(e) {
                e.preventDefault();
                loadTasks($(this).serialize());
            });

            $(document).on('submit', '.update-task-form', function(e) {
                e.preventDefault();
                const taskId = $(this).data('task-id');
                $.post(`/update_task/${taskId}`, $(this).serialize(), function(response) {
                    if (response.success) {
                        loadTasks();
                        loadDashboard();
                        alert('Task updated successfully!');
                    } else {
                        alert('Error updating task. Please try again.');
                    }
                }).fail(function() {
                    alert('Error updating task. Please try again.');
                });
            });

            $(document).on('click', '.show-comments', function() {
                const taskId = $(this).data('task-id');
                const commentsRow = $(`#comments-${taskId}`);
                if (commentsRow.is(':visible')) {
                    commentsRow.hide();
                } else {
                    $.get(`/get_comments/${taskId}`, function(comments) {
                        let commentsHtml = '<ul>';
                        comments.forEach(function(comment) {
                            commentsHtml += `<li>${comment.content} - ${comment.timestamp}</li>`;
                        });
                        commentsHtml += '</ul>';
                        commentsRow.find('.comments-container').html(commentsHtml);
                        commentsRow.show();
                    });
                }
            });

            $(document).on('submit', '.add-comment-form', function(e) {
                e.preventDefault();
                const taskId = $(this).data('task-id');
                $.post(`/add_comment/${taskId}`, $(this).serialize(), function(response) {
                    if (response.success) {
                        $(`#comments-${taskId}`).hide();
                        $(`.show-comments[data-task-id="${taskId}"]`).click();
                        alert('Comment added successfully!');
                    } else {
                        alert('Error adding comment. Please try again.');
                    }
                }).fail(function() {
                    alert('Error adding comment. Please try again.');
                });
                $(this)[0].reset();
            });

            $(document).on('click', '.add-subtask', function() {
                const parentId = $(this).data('task-id');
                const subtaskForm = `
                    <form class="add-subtask-form" data-parent-id="${parentId}">
                        <input type="text" name="title" placeholder="Subtask Title" class="form-control mb-2" required>
                        <textarea name="description" placeholder="Subtask Description" class="form-control mb-2" required></textarea>
                        <input type="text" name="assigned_to" placeholder="Assigned To" class="form-control mb-2" required>
                        <input type="date" name="due_date" class="form-control mb-2" required>
                        <select name="priority" class="form-control mb-2" required>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        <input type="text" name="categories" placeholder="Categories (comma-separated)" class="form-control mb-2">
                        <button type="submit" class="btn btn-sm btn-primary">Add Subtask</button>
                    </form>
                `;
                $(this).after(subtaskForm);
                $(this).hide();
            });

            $(document).on('submit', '.add-subtask-form', function(e) {
                e.preventDefault();
                const parentId = $(this).data('parent-id');
                $.post(`/add_subtask/${parentId}`, $(this).serialize(), function(response) {
                    if (response.success) {
                        loadTasks();
                        loadDashboard();
                        alert('Subtask added successfully!');
                    } else {
                        alert('Error adding subtask. Please try again.');
                    }
                }).fail(function() {
                    alert('Error adding subtask. Please try again.');
                });
                $(this).remove();
                $(`.add-subtask[data-task-id="${parentId}"]`).show();
            });

            $(document).on('submit', '.time-tracking-form', function(e) {
                e.preventDefault();
                const taskId = $(this).data('task-id');
                $.post(`/update_time_spent/${taskId}`, $(this).serialize(), function(response) {
                    if (response.success) {
                        loadTasks();
                        loadDashboard();
                        alert('Time logged successfully!');
                    } else {
                        alert('Error logging time. Please try again.');
                    }
                }).fail(function() {
                    alert('Error logging time. Please try again.');
                });
                $(this)[0].reset();
            });

            $('#recurring').change(function() {
                if (this.checked) {
                    $('#recurring-options').show();
                } else {
                    $('#recurring-options').hide();
                }
            });
        });
    </script>
</body>
</html>
